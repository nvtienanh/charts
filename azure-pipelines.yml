# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

pool:
    name: test
jobs:
- job: no_checkout
  
  container:
    image: nvtienanh/cmake:5.0
    volumes:
      - /nfsdata:/nfsdata
      - /conan:/conan
  variables:
    CCACHE_DIR: /nfsdata
    CONAN_USER_HOME: /conan
  steps:
  - task: Cache@2
    displayName: Conan caching
    inputs:
      key: 'conan | "$(Agent.OS)" | **/conanfile.py'
      path: $(CONAN_USER_HOME)
      restoreKeys: | 
        conan | "$(Agent.OS)"
        conan
      cacheHitVar: CONAN_CACHE_RESTORED

  - task: Cache@2
    displayName: Ccache caching
    inputs:
      key: 'ccache | "$(Agent.OS)" | $(Build.SourceVersion)'
      path: $(CCACHE_DIR)
      restoreKeys: | 
        ccache | "$(Agent.OS)"
      cacheHitVar: CCACHE_RESTORED

  - script: |
      gcc -
      conan profile detect
      # conan profile update settings.compiler.libcxx=libstdc++11 default
      # conan profile update settings.compiler.cppstd=gnu17 default      
      conan install . --output-folder=build --build=missing
      
      # cmake -B build -G Ninja
      cmake -B build -G Ninja -DCMAKE_TOOLCHAIN_FILE=conan_toolchain.cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
      cmake --build ./build
    displayName: 'Run cmake'



# - job: checkout
#   dependsOn: no_checkout

#   container:
#     image: nvtienanh/cmake:5.0
#     volumes:
#       - /temcache:/temcache
#       - /blobfuse2:/blobfuse2
#   steps:
#   - checkout: none
#   - script: |
#       ls -la /temcache
#       azcopy --version
#   condition: always()
#   displayName: 'Run cmake'


